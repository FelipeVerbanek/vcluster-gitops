apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: sqs-with-dlq
spec:
  compositeTypeRef:
    apiVersion: messaging.example.io/v1alpha1
    kind: XSQSQueue
  
  mode: Pipeline
  pipeline:
  - step: dlq
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      - name: dlq
        base:
          apiVersion: sqs.aws.crossplane.io/v1beta1
          kind: Queue
          spec:
            forProvider:
              messageRetentionSeconds: 1209600
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.queueName
          toFieldPath: metadata.name
          transforms:
          - type: string
            string:
              type: Format
              fmt: "%s-dlq"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.queueName
          toFieldPath: spec.forProvider.name
          transforms:
          - type: string
            string:
              type: Format
              fmt: "%s-dlq"
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.url
          toFieldPath: status.dlqUrl
          policy:
            fromFieldPath: Optional

      - name: main-queue
        base:
          apiVersion: sqs.aws.crossplane.io/v1beta1
          kind: Queue
          spec:
            forProvider:
              visibilityTimeoutSeconds: 30
              messageRetentionSeconds: 345600
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.queueName
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.queueName
          toFieldPath: spec.forProvider.name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.visibilityTimeout
          toFieldPath: spec.forProvider.visibilityTimeoutSeconds
        - type: FromCompositeFieldPath
          fromFieldPath: spec.messageRetentionPeriod
          toFieldPath: spec.forProvider.messageRetentionSeconds
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.url
          toFieldPath: status.queueUrl
          policy:
            fromFieldPath: Optional

      - name: iam-role
        base:
          apiVersion: iam.aws.crossplane.io/v1beta1
          kind: Role
          spec:
            forProvider:
              assumeRolePolicy: |
                {
                  "Version": "2012-10-17",
                  "Statement": [{
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "eks.amazonaws.com",
                      "Federated": "arn:aws:iam::000000000000:oidc-provider/oidc.eks.us-east-1.amazonaws.com"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity"
                  }]
                }
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.iamRoleName
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.iamRoleName
          toFieldPath: spec.forProvider.name
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.arn
          toFieldPath: status.roleArn
          policy:
            fromFieldPath: Optional

      - name: iam-policy
        base:
          apiVersion: iam.aws.crossplane.io/v1beta1
          kind: RolePolicy
          spec:
            forProvider:
              roleSelector:
                matchControllerRef: true
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.iamRoleName
          toFieldPath: metadata.name
          transforms:
          - type: string
            string:
              type: Format
              fmt: "%s-policy"
        - type: CombineFromComposite
          combine:
            variables:
            - fromFieldPath: spec.queueName
            strategy: string
            string:
              fmt: |
                {
                  "Version": "2012-10-17",
                  "Statement": [{
                    "Effect": "Allow",
                    "Action": [
                      "sqs:SendMessage",
                      "sqs:ReceiveMessage",
                      "sqs:DeleteMessage",
                      "sqs:GetQueueAttributes"
                    ],
                    "Resource": "arn:aws:sqs:us-east-1:000000000000:%s"
                  }]
                }
          toFieldPath: spec.forProvider.document
